#!/bin/bash

# if [ "$(ps -e | grep weston)" != "" ]; then
#     exit
# fi

cd /run/user/$UID/
FOLDER="/run/user/$UID"
FILENAME="waydroid"

#WAYLAND_DISPLAY="$(ls -1t waydroid* | grep -v '.lock' | head -1)" waydroid show-full-ui

if [ -e "${FOLDER}/${FILENAME}" ] ; then
    i=1
    while [ -e "${FOLDER}/${FILENAME}${i}" ] ; do
        let i++
    done
        DISPLAY_NUMBER="$i"
fi


#Run root daemon
if [ "$(ps -aux | grep waydroid | grep container)" = "" ]; then
    pkexec waydroid-big-start
fi

sleep 1

# wait
if [ "$(ps -aux | grep waydroid | grep container)" = "" ]; then
    sleep 1
fi

# wait
if [ "$(ps -aux | grep waydroid | grep container)" = "" ]; then
    sleep 1
fi

# wait
if [ "$(ps -aux | grep waydroid | grep container)" = "" ]; then
    sleep 1
fi

WAYLAND_DISPLAY=waydroid${DISPLAY_NUMBER} waydroid show-full-ui &



#Xorg
if [ "$(ps -e | grep Xorg)" != "" ]; then
    echo '[core]
idle-time=0

[shell]
panel-location=""
panel-position=none
locking=false
background-image=/usr/share/waydroid-extra/loading-android.jpg
background-type=scale-crop' > ~/.config/weston.ini

weston -S waydroid${DISPLAY_NUMBER} --width=6000 --height=6000
waydroid session stop
fi
